<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QueueView - v 1.0</title>

  <!-- New responsive jukebox UI styles -->
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="queue-container">
    <h1 class="title">Generic Coffee Shop Name</h1>

    <h2 class="nowplaying-header">Now Playing</h2>
    <div class="nowplaying">
      <img src="https://via.placeholder.com/72" alt="Cover art" loading="lazy">
      <div>
        <div class="title"><strong>Song Title</strong></div>
        <div class="byline">Artist — <em>Album</em></div>
        <div class="controls">
          <button class="btn secondary">Pause</button>
          <button class="btn secondary">Skip</button>
        </div>
      </div>
    </div>

    <h2 class="queue-header">Up Next</h2>
    <button id="refreshQueueBtn" class="btn" style="margin-bottom:10px;">
  Refresh Queue
    </button>

    <div id="queue" class="queue-list" role="list">
      <div class="queue-item" role="listitem">
        <img src="https://via.placeholder.com/64" alt="Cover art" loading="lazy">
        <div>
          <div class="title"><strong>Loading track…</strong></div>
          <div class="byline"><em>Please wait</em></div>
        </div>
        <div class="actions">
          <div class="vote-stack">
            <button class="btn" aria-label="Upvote">▲</button>
            <div class="vote-count">0</div>
            <button class="btn secondary" aria-label="Downvote">▼</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/queue.js"></script>
  
  <script>

    // Turn whatever is inside #queue into .queue-item cards
    function decorateQueue() {
      const q = document.getElementById('queue');
      if (!q) return;

      const raw = [...q.children].map(el => el.textContent.trim()).filter(Boolean);

      q.innerHTML = '';
      for (const name of raw) {
        const item = document.createElement('div');
        item.className = 'queue-item';
        item.setAttribute('role', 'listitem');
        item.innerHTML = `
          <img src="https://via.placeholder.com/64" alt="Cover art" loading="lazy">
          <div>
            <div class="title"><strong>${name}</strong></div>
            <div class="byline">Artist — <em>Unknown</em></div>
          </div>
          <div class="actions">
            <div class="vote-stack">
              <button class="btn" aria-label="Upvote">▲</button>
              <div class="vote-count">0</div>
              <button class="btn secondary" aria-label="Downvote">▼</button>
            </div>
          </div>`;
        q.appendChild(item);
      }
    }

    // Wrap teammate’s refresh to decorate after it runs
    const originalPrintQueue = (window.test && test.printQueue) ? test.printQueue : null;
    if (originalPrintQueue) {
      test.printQueue = async function(...args) {
        const r = await originalPrintQueue.apply(this, args);
        decorateQueue();
        return r;
      };
    }
    decorateQueue();

    // simple UI-only voting (no backend) 
document.getElementById('queue')?.addEventListener('click', (e) => {
  const up = e.target.closest('.actions .btn:not(.secondary)');   // ▲
  const down = e.target.closest('.actions .btn.secondary');        // ▼
  if (!up && !down) return;

  const item = e.target.closest('.queue-item');
  const countEl = item?.querySelector('.vote-count');
  if (!item || !countEl) return;

  let n = parseInt(countEl.textContent || '0', 10) || 0;

  if (up) {
    n += 1;
    up.classList.add('pressed');
    item.querySelector('.actions .btn.secondary')?.classList.remove('pressed');
  } else if (down) {
    n = Math.max(0, n - 1);
    down.classList.add('pressed');
    item.querySelector('.actions .btn:not(.secondary)')?.classList.remove('pressed');
  }
  countEl.textContent = String(n);

  // instant feedback 
  const toast = document.getElementById('toast') || (() => {
    const t = document.createElement('div');
    t.id = 'toast';
    t.className = 'toast';
    document.body.appendChild(t);
    return t;
  })();
  toast.textContent = up ? 'Upvoted' : 'Downvoted';
  toast.style.display = 'block';
  setTimeout(() => (toast.style.display = 'none'), 900);
});

  // Refresh queue
  async function refreshQueue() {
    if (window.test?.printQueue) {
      await window.test.printQueue();
      decorateQueue();
      mirrorNowPlayingFromFirstItem();
    }
  }

  document.getElementById('refreshQueueBtn')?.addEventListener('click', refreshQueue);

// Copy the first queue item’s title/artist into the Now Playing block
function mirrorNowPlayingFromFirstItem() {
  const first = document.querySelector('#queue .queue-item');
  const np = document.querySelector('.nowplaying');
  if (!first || !np) return;

  const title = first.querySelector('.title strong')?.textContent?.trim() || 'Song Title';
  const byline = first.querySelector('.byline')?.textContent?.trim() || 'Artist — Album';
  const imgSrc = first.querySelector('img')?.src || 'https://via.placeholder.com/72';

  np.querySelector('img').src = imgSrc;
  np.querySelector('.title strong').textContent = title;
  np.querySelector('.byline').innerHTML = byline;
}

// Run once at load and after every decorate
mirrorNowPlayingFromFirstItem();

// Optional: auto-refresh every 10s; remove if not needed)
const AUTO_REFRESH_MS = 10000;
setInterval(() => {
  if (document.hasFocus()) {  // don’t spam when tab not active
    refreshQueue?.();
  }
}, AUTO_REFRESH_MS);

  </script>
</body>
</html>